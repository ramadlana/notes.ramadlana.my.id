---
{"dg-publish":true,"permalink":"/digital-garden/multicast-pim-sparse-mode-lab-and-how-it-works/","noteIcon":""}
---

# PIM-SM Dictionary

| Term                     | Explanation                                                                                                                                                                                                                                                                                            |
| ------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| RP                       | Rendezvous Point - Is brain of PIM-SM, all router if want to receive / send a stream, need to communicate with RP, optionally later on they can find shortest path if available                                                                                                                        |
| C-RP                     | Candidate Rendezvous Point - this is mean PIM router is a candidate RP for dynamic RP election instead using static RP a                                                                                                                                                                               |
| LHR                      | Last Hop Router - PIM Router where is Receiver connected (sometimes there is switch (without PIM, only IGMP snoop)                                                                                                                                                                                     |
| FHR                      | First Hop Router - PIM Router where is Sender connected into (sometimes there is switch (without PIM, only IGMP snoop)                                                                                                                                                                                 |
| Shared Tree (\*,G)       | Shared Tree (\*,G) is a distribution path in PIM-SM that connects the Rendezvous Point (RP) to First Hop Routers (FHRs) and Last Hop Routers (LHRs), with the RP acting as the root. Initial multicast traffic flows through the RP before potentially switching to a more optimal route if available. |
| Shortest-path Tree (S,G) | Its pathway between LHR and FHR. sometimes its have same path with shared tree, or its have own path. depending on our configuration                                                                                                                                                                   |
| BSRs                     | Bootstrap Router. Its central administrative PIM-SM domain to manage RP election and distribute RP information to other routers                                                                                                                                                                        |
| C-BSRs                   | Candidate Bootstrap Routers. This is device is candidate to become BSR in BSR election process. or if already elected this router become BSR if other elected BSR is down                                                                                                                              |
| PIM-Join                 | is primarily generated by LHR to RP, indicating interest in receiving multicast data for particular group                                                                                                                                                                                              |
| PIM-Register             | is **Unicast** messages sent by FHR to RP to register multicast source, informing RP about the source location. first stream from sender will encapsulate to it.                                                                                                                                       |
| PIM-Register/Stop        | is messages from RP to response PIM-Register. And inform FHR if RP now ready to receive stream                                                                                                                                                                                                         |
| PIM-Prune                | message sent to remove branch from multicast distribution tree when there are no longer interested receiver                                                                                                                                                                                            |
| RPF                      | Reverse Path Forwarding. A mechanism to ensure loop-free forwarding of multicast packet. and also make sure multicast packet is arrive via best path back to the source by looking up Routing table                                                                                                    |

# How PIM-SM Works summary
![Pasted image 20241004143239.png](/img/user/97%20Attachments/Pasted%20image%2020241004143239.png)
1. First PIM will perform Rendezvous Point or RP election, this process must be perform and RP must be elected first in PIM-SM without RP we cannot route any multicast stream in PIM-SM. (This step have long process, explained in detail bellow). Then, once RP is elected,
2. Then, Last Hop Router (LHR) where nearest PIM router with receiver connected into, Received IGMP join multicast group, and this LHR sends join messages (\*,G) to RP. this join messages is forwarded hop-by-hop through any intermediate PIM router if available until finally reach the RP. and this intermediate PIM router keep track this join state in PIM cache. so these intermediate PIM router know where packet come in and come out for this group
3. PIM-Join finally reach RP, and now RP know which router interested for these multicast group
4. Sender send first stream to FHR using IGMP, then FHR send this stream in encapsulated into unicast packet to RP this packet called PIM-Register.
5. If there any intermediate PIM router in between, these PIM router just forward to correct destination by looking a Routing Table. 
6. RP received PIM-Register, and response with PIM-Register/Stop which mean like acknowledge message and inform the FHR if RP now ready to receive the following stream
7. If later on direct path / shortest path between FHR to LHR is establish (if FHR packet can reach LHR without going through the RP). then communication can occur directly between them without RP.

**RP Election Process**
In PIM-SM (Sparse Mode) we can specify RP using several mechanism like static and dynamic. Dynamic way is more recommended because its redundancy, scalability, etc. EXOS using BSR (Bootstrap Router) to elect the RP. BSR is used to dynamically distribute RP information to all PIM router in the multicast domain.
**1. Bootstrap Router Election**
EXOS Command: `configure pim cbsr vlan MyVLAN 0-255`
1. One or more router configured as Candidate BSR (C-BSRs) in the network. this C-BSRs router periodically generate and sent out BSM messages to all PIM router within PIM domain
2. If there other router C-BSRs receive it, it will compare with own priority. if this router receive higher priority BSM (lower value priority). then this router suppress it self to not sent out BSM messages anymore.
3. At the end only one C-BSR with BSMs flood periodically to PIM domain
![Pasted image 20241004230850.png](/img/user/97%20Attachments/Pasted%20image%2020241004230850.png)
![Pasted image 20241004232109.png](/img/user/97%20Attachments/Pasted%20image%2020241004232109.png)
Important Point:
- Elected BSR is ==not always== elected RP. 
- Elected BSR is central point to distribute RP information so other PIM router no need configure RP manually or statically
- RP is central / Brain for distribution point for multicast traffic
- But its possible elected BSR also RP. Depends on our configuration and election. 

Bellow is example:
- Switch-4 is a BSR, and Also act as RP for group 227.1.1.1
- Switch-4 is a BSR, but not an RP for group 225.1.1.1, which is RP for these group is Switch-3
```
* S4.2 # show pim
PIM Enabled, Version 2
BSR state           : ELECTED ; BSR Hash Mask : 255.255.255.252 --> ELECTED BSR

S3.2 # show pim rp-set 
Group           Mask            C-RP            Origin    Priority  Timeout   
225.1.1.0       255.255.255.0   13.1.1.3        Bootstrap 30        102  --> THIS IS Switch-3     
227.1.1.0       255.255.255.0   34.1.1.4        Bootstrap 192       102  --> THIS IS Switch-4
```

After BSR is elected, then every C-RP inform periodically to this BSR, as follow:

**2. Candidate RP Configuration and Election** 
<u>How BSR send C-RP information to all PIM router?</u>
- Configured C-RP send periodic Candidate-RP-Advertisement to C-BSRs. These advertisement contain the multicast group that C-RP willing to serve
- Elected BSR listen for these advertisements from C-RP, and collect the information. Then compile it into RP-Set and following information and sent out to all PIM router using Bootstrap Messages (BSMs)
- RP-Set contain multicast group range which each C-RP responsible. it included IP address of RP and following with the group ranges IP address.
- ==C-RP with lowest priority value will elected as RP==. This is need carefully set because ==C-BSR use highest value to elect BSR== 
- Each PIM Router in domain perform calculation and choose the RP based on RP-Set provided by BSR. (BSR not elect RP for everyone, but each PIM router do for itself)
```
* S3.11 # show pim rp-set
Group           Mask            C-RP            Origin    Priority  Timeout   
225.1.1.0       255.255.255.0   34.1.1.3        Bootstrap 192       128       
227.1.1.0       255.255.255.0   24.1.1.2        Bootstrap 100       128  ---> This is Elected    
227.1.1.0       255.255.255.0   34.1.1.4        Bootstrap 192       128    

S6.1 # show pim cache detail 
Index  Dest Group      Source             InVlan   Origin 
[0001] 227.1.1.1       20.1.1.10 (S)      sen2     Sparse         
       Expires after 200 secs UpstNbr: 0.0.0.0
       RP: 24.1.1.2 via 46.1.1.4 in s6_s4 --> Elected RP
```
Example candidate RP Advertisement from Switch-2 as one of our C-RP to Elected BSR Switch-4 (34.1.1.4)
```
* S4.3 # show pim
BSR state           : ELECTED 
```
![Pasted image 20241004232001.png](/img/user/97%20Attachments/Pasted%20image%2020241004232001.png)

Configuration example for C-RP
```
vi rp_list.pol

entry rp_list {
if match any {
	}
then {
	nlri 237.1.1.0/24;
	}
}

check policy rp_list.pol
configure pim crp MyVLAN rp_list
```

Now our PIM domain have Information where is RP, which group will serve, and we have BSR as advertiser C-RP information. then we ready to move to packet flow to get some stream flow over our PIM domain
once RP is set, then we ready to flowing some stream.

# Multicast Flow for group 227.1.1.1
## 1. LHR <---> RP Flow
First, End-User **Rec2** will issue IGMP report and tell **Switch-1** if its interested in 227.1.1.1 group. After receive it then now **Switch-1** know is **Rec2** interested those group
```
S1.1 # show igmp snooping 
Igmp Snooping Flag            : forward-all-router
Igmp Snooping Flood-list      : none 
Igmp Snooping Proxy           : Enable 

Vlan             Vid  Port   #Senders #Receivers Router Enable
--------------------------------------------------------------
-Truncated-
Rec2             104         0                           Yes 
                      10               1          No
                      
S1.40 # show igmp group 227.1.1.1
Group Address     Ver Vlan            Port     Age  
227.1.1.1         2   Rec2            10       0    
```

```
S1.38 # show pim rp-set 
Group           Mask            C-RP            Origin    Priority  Timeout   
225.1.1.0       255.255.255.0   13.1.1.3        Bootstrap 30        109       
227.1.1.0       255.255.255.0   34.1.1.4        Bootstrap 192       109       

S1.41 # sh iproute 34.1.1.4/24
Ori  Destination        Gateway         Mtr  Flags         VLAN       Duration
#oa  34.1.1.0/24        13.1.1.3        10   UG-D---um--f- s1_s3      0d:1h:52m:57s

S1.28 # show pim cache 227.1.1.1
Index  Dest Group      Source             InVlan   Origin 
[0000] 227.1.1.1       34.1.1.4 (WR)      s1_s3    Sparse         
       Entry timer is not run; UpstNbr: 13.1.1.3
       EgressIfList =  Rec2(0)(FW)(SM)(I) 
```

From `show pim cache 227.1.1.1` output on Switch-1 we know (\*,G) is through Switch-3 then go to Switch-4 as RP. These behavior is expected because this group RP, the is 34.1.1.4 and out VLAN is S1_S3 with next-hop 13.1.1.3 which is Switch-3.
In the Switch-3 its not only forward the PIM Join message, Its also keep track in PIM cache, if later stream come from InVlan, Switch-3 know where to forward those stream.
```
* S3.7 # show pim cache 227.1.1.1
Index  Dest Group      Source             InVlan   Origin 
[0000] 227.1.1.1       34.1.1.4 (WR)      s3_s4    Sparse         
       Expires after 162 secs UpstNbr: 34.1.1.4
       EgressIfList =  s3_s1(162)(FW)(SM)(Z) 
```

Finally PIM Join for 227.1.1.1 is arrived on Switch-4 as RP. then keep track in PIM cache. if later stream come from somewhere, Switch-4 as RP know where to forward those stream.
```
* S4.9 # show pim cache 227.1.1.1
Index  Dest Group      Source             InVlan   Origin 
[0000] 227.1.1.1       34.1.1.4 (WR)      (null)   Sparse         
       Expires after 162 secs UpstNbr: 0.0.0.0
       EgressIfList =  s4_s3(162)(FW)(SM)(Z)  
```
Here our Shared Tree picture so far:
![Pasted image 20241004224314.png](/img/user/97%20Attachments/Pasted%20image%2020241004224314.png)

> [!NOTE]
> Now Shared Tree or \*,G between receiver and RP was completed. And Rec-2 Ready to receive multicast 227.1.1.1 from RP

## 2. LHR <=> RP <=> FHR Flow
Then when Sen-2 start sending Multicast  stream,**Sen-2** sent the stream directly to PIM-RP since this is **first packet** and encapsulated inside PIM-Register Unicast. And Since **Switch-4 (RP)** and **Rec-2** already have Shared-Tree, then stream will forwarded down to Rec-2 through this Shared Tree. Bellow is output PIM cache from Switch-6 as FHR
```
S6.6 # show pim cache 227.1.1.1
Index  Dest Group      Source             InVlan   Origin 
[0001] 227.1.1.1       20.1.1.10 (S)      sen2     Sparse         
       Expires after 193 secs UpstNbr: 0.0.0.0
       RP: 34.1.1.4 via 56.1.1.5 in s6_s5
       EgressIfList =  s6_s4(162)(FW)(SM)(S)  
```
We can see Egress interface is toward Switch-4 with InVlan is from vlan sen2. Here our picture of our flow so far:
![Pasted image 20241004224715.png](/img/user/97%20Attachments/Pasted%20image%2020241004224715.png)


**Next**, this lab required to manipulate cost with result traffic to Receiver-2 40.1.1.10 is using path Switch6 -> Switch5 -> Switch3 -> Switch1. So following stream for 227.1.1.1 group, expect to not using shared three all the time, instead we use other determined path as Shortest-path Tree (S,G).
We need to manipulate OSPF cost first
```
S1.3 # configure ospf vlan s1_s2 cost 1000
S3.3 # configure ospf vlan s3_s4 cost 1000
S6.10 # configure ospf vlan s6_s4 cost 1000
```

Switch-6 (FHR) PIM cache after manipulate path, now path toward RP (s6_s4 interface is pruned) so next stream will not use that path:
```
S6.9 # show pim cache detail 
Index  Dest Group      Source             InVlan   Origin 
[0001] 227.1.1.1       20.1.1.10 (S)      sen2     Sparse         
       Expires after 197 secs UpstNbr: 0.0.0.0
       RP: 34.1.1.4 via 46.1.1.4 in s6_s4
       EgressIfList =  s6_s5(196)(FW)(SM)(S) 
       PrunedIfList =  s6_s4(0)(SM) 
```

RP Output:
```
* S4.1 # show pim cache 227.1.1.1
Index  Dest Group      Source             InVlan   Origin 
[0000] 227.1.1.1       34.1.1.4 (WR)      (null)   Sparse         
       Expires after 167 secs UpstNbr: 0.0.0.0
       EgressIfList =  s4_s3(167)(FW)(SM)(Z) 

[0001] 227.1.1.1       20.1.1.10 (S)      s4_s6    Sparse         
       Expires after 198 secs UpstNbr: 46.1.1.6
       RP: 34.1.1.4 via 34.1.1.4 in (null)
       EgressIfList =  s4_s3(167)(FW)(SM)(ZS) 
       PrunedIfList =  s4_s2(0)(SM)  
```

Other PIM router in the path PIM cache:
```
* S5.3 # show pim cache detail 
Index  Dest Group      Source             InVlan   Origin 
[0001] 227.1.1.1       20.1.1.10 (S)      s5_s6    Sparse         
       Expires after 192 secs UpstNbr: 56.1.1.6
       RP: 34.1.1.4 via 35.1.1.3 in s5_s3
       EgressIfList =  s5_s3(161)(FW)(SM)(S) 

S3.7 # show pim cache detail
Index  Dest Group      Source             InVlan   Origin 
[0000] 227.1.1.1       34.1.1.4 (WR)      s3_s4    Sparse         
       Expires after 175 secs UpstNbr: 34.1.1.4
       EgressIfList =  s3_s1(175)(FW)(SM)(Z) 

[0001] 227.1.1.1       20.1.1.10 (S)      s3_s5    Sparse         
       Expires after 206 secs UpstNbr: 35.1.1.5
       RP: 34.1.1.4 via 34.1.1.4 in s3_s4
       EgressIfList =  s3_s1(175)(FW)(SM)(ZS) 

S1.10 # show pim cache detail 
Index  Dest Group      Source             InVlan   Origin 
[0000] 227.1.1.1       34.1.1.4 (WR)      s1_s3    Sparse         
       Entry timer is not run; UpstNbr: 13.1.1.3
       EgressIfList =  Rec2(0)(FW)(SM)(I) 

[0001] 227.1.1.1       20.1.1.10 (S)      s1_s3    Sparse         
       Expires after 192 secs UpstNbr: 13.1.1.3
       RP: 34.1.1.4 via 13.1.1.3 in s1_s3
       EgressIfList =  Rec2(0)(FW)(SM)(I) 
```

WR entry or Shared Tree will remain there, and Shortest-Path Tree added to the list, so in picture flow be like picture bellow:
![Pasted image 20241005001444.png](/img/user/97%20Attachments/Pasted%20image%2020241005001444.png)



# Multicast Flow for group 225.1.1.1
The process stream flow is same, but the different with group 227.1.1.1 is, this group has RP on Switch-3. If we take a look at Switch 1, we have same path both for Shared Tree and Shortest-Path Tree.
```
S1.6 #  show igmp snooping detail
VLAN Rec1             (103) Snooping=Enabled  
    Port   Host            Subscribed        Age    Group-Limit    
    9      30.1.1.10       225.1.1.1         0      0              
VLAN Rec2             (104) Snooping=Enabled 

S1.3 # show pim cache 225.1.1.1
Index  Dest Group      Source             InVlan   Origin 
[0000] 225.1.1.1       34.1.1.3 (WR)      s1_s3    Sparse         
       Entry timer is not run; UpstNbr: 13.1.1.3
       EgressIfList =  Rec1(0)(FW)(SM)(I) 

[0001] 225.1.1.1       10.1.1.10 (S)      s1_s3    Sparse         
       Expires after 182 secs UpstNbr: 13.1.1.3
       RP: 34.1.1.3 via 13.1.1.3 in s1_s3
       EgressIfList =  Rec1(0)(FW)(SM)(I) 
```

On Switch-3 (RP), we have Shared Tree populated from PIM Join (WR) and have Source tree entry populated from PIM-Register (S). So if in 227.1.1.1 group we have different path between Shared Tree (WR) and Source Tree (S), group 225.1.1.1 in other hand have same path for Shared and Source tree. this is possible because Source Tree (best path) is same with path on Shared Tree 
```
S3.3 # show pim cache 225.1.1.1
Index  Dest Group      Source             InVlan   Origin 
[0000] 225.1.1.1       34.1.1.3 (WR)      (null)   Sparse         
       Expires after 202 secs UpstNbr: 0.0.0.0
       EgressIfList =  s3_s1(202)(FW)(SM)(Z) 

[0001] 225.1.1.1       10.1.1.10 (S)      s3_s5    Sparse         
       Expires after 202 secs UpstNbr: 35.1.1.5
       RP: 34.1.1.3 via 0.0.0.0 in (null)
       EgressIfList =  s3_s1(202)(FW)(SM)(ZS) 
```

```
S5.3 # show pim cache 225.1.1.1
Index  Dest Group      Source             InVlan   Origin 
[0001] 225.1.1.1       10.1.1.10 (S)      sen1     Sparse         
       Expires after 185 secs UpstNbr: 0.0.0.0
       RP: 34.1.1.3 via 35.1.1.3 in s5_s3
       EgressIfList =  s5_s3(154)(FW)(SM)(S) 
```

Here our picture for group 225.1.1.1

![Pasted image 20241007095654.png](/img/user/97%20Attachments/Pasted%20image%2020241007095654.png)

This is packet capture taken from Rec1<->Switch 1, Rec1 received multicast stream for 225.1.1.1
![Pasted image 20241007095355.png](/img/user/97%20Attachments/Pasted%20image%2020241007095355.png)
# PIM-SM Troubleshooting tips
Make sure router PIM, interface PIM, forwarding interface, interface Multicast Forwarding, and sparse or dense mode are enabled. the easiest way to check the flags in each vlan is using `show pim`
```
S5.9 # show pim
PIM Enabled, Version 2
PIM CRP Disabled

Current BSR Info    : 34.1.1.4 (Priority 100) expires after 76 sec

VLAN       Cid  IP Address         Designated      Flags        Hello J/P   Nbrs 
                                   Router                       Int   Int      
loopback1     1 5.5.5.5        / 32 5.5.5.5         rifms------- 30    60    0    
s5_s6         2 56.1.1.5       / 24 56.1.1.6        rifms------- 30    60    1    
s5_s3         3 35.1.1.5       / 24 35.1.1.5        rifms------- 30    60    1    
sen1          4 10.1.1.1       / 24 10.1.1.1        rifms------- 30    60    0    
 
Legend: J/P Int: Join/Prune Interval
  Flags : r - Router PIM Enabled, i - Interface PIM Enabled, f - Interface,
        Forwarding Enabled, m - Interface Multicast Forwarding Enabled,
        s - Sparse mode, d - Dense mode, c - CRP enabled,
```

Make sure routing protocol is enabled on interfaces using `show vlan` 
```
S5.10 # show vlan
Untagged ports auto-move: Inform
-----------------------------------------------------------------------------------------------
Name            VID  Protocol Addr       Flags                         Proto  Ports  Virtual   
                                                                              Active router
                                                                              /Total
-----------------------------------------------------------------------------------------------
Default         1    --------------------------------T-------------    ANY    0 /0   VR-Default 
loopback1       500  5.5.5.5        /32  -fL-----mop---------------    ANY    0 /0   VR-Default 
Mgmt            4095 ----------------------------------------------    ANY    0 /1   VR-Mgmt    
s5_s3           502  35.1.1.5       /24  -f------mop---------------    ANY    1 /1   VR-Default 
s5_s6           501  56.1.1.5       /24  -f------mop---------------    ANY    1 /1   VR-Default 
sen1            503  10.1.1.1       /24  -f------mop---------------    ANY    1 /1   VR-Default 
-----------------------------------------------------------------------------------------------
Flags : (B) BFD Enabled, (c) 802.1ad customer VLAN, (C) EAPS Control VLAN,
        (d) Dynamically created VLAN, (D) VLAN Admin Disabled,
        (E) ESRP Enabled, (f) IP Forwarding Enabled,
        (F) Learning Disabled, (i) ISIS Enabled,
        (I) Inter-Switch Connection VLAN for MLAG, (k) PTP Configured,
        (l) MPLS Enabled, (L) Loopback Enabled, (m) IPmc Forwarding Enabled,
        (M) Translation Member VLAN or Subscriber VLAN, (n) IP Multinetting Enabled,
        (N) Network Login VLAN, (o) OSPF Enabled, (O) Virtual Network Overlay,
        (p) PIM Enabled, (P) EAPS protected VLAN, (r) RIP Enabled,
```